name: Format and lint

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NXF_ANSI_LOG: "false"

jobs:
  gate:
    name: Lint + Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"
      - name: Setup ssh key
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: |
            ${{ secrets.SSH_PRIVATE_KEY_SIDUS }}
            ${{ secrets.SSH_PRIVATE_KEY_CIRCUSS }}

      - name: Install Python deps and linters
        run: |
          pip install --no-deps "circuss @ git+https://github.com/DSidLab/circuss.git@main"
          pip install --no-deps "sidus @ git+https://github.com/AstroPathJHU/sidus.git@main"
          pip install --no-deps cirro
          pip install --no-deps multiqc
          pip install .[test]

      # - name: Ruff (lint)
      #   run: ruff check .

      - name: Run cirro preprocessing script unit tests
        run: python -m unittest discover -s .cirro -p '*_test.py'

      - name: Run pre-commit
        run: pre-commit run --all-files

      # --- nf-core / Nextflow checks ---
      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Nextflow
        uses: nf-core/setup-nextflow@v1
        with:
          version: "latest" # pin if you prefer

      # - name: Install nf-core/tools
      #   run: python -m pip install nf-core

      # - name: nf-core pipelines lint
      #   run: nf-core pipelines lint --dir .

      - name: Nextflow config check
        run: |
          nextflow -version
          nextflow config -flat .
