nextflow_pipeline {

    name "sample sheet format"
    script "main.nf"

    tag "pipeline"

    config "conf/test.config"

    test("Should produce an error with invalid sample sheet format") {
        tag "invalid_sample_format"
        when {
            params {
              input = 'dummy'
            }
        }

        then {
            assert workflow.failed
            def err = (workflow.errorReport ?: workflow.stderr ?: "NO ERROR MESSAGE").toString()
            assert err.contains("\"dummy\" does not match")
        }

    }

    test("Should produce an error with invalid sample sheet sample path format") {
        tag "invalid_sample_path"
        when {
            params {
              input = "$baseDir/tests/data/samples_bad_path.csv"
            }
        }

        then {
            assert workflow.failed
            def err = (workflow.errorReport ?: workflow.stderr ?: "NO ERROR MESSAGE").toString()
            assert err.contains("the file or directory 'dummy_path1' does not exist")
        }

    }

    test("Should run successfully") {

        tag "valid_run"
        when {
            params {
              input = "$baseDir/tests/data/samples.csv"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should run successfully with mixcr") {

        tag "valid_run_with_mixcr"
        when {
            params {
              input = "$baseDir/tests/data/samples_test_mixcr.csv"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should run successfully with samples needing and not needing alignment") {

        tag "valid_run_full"
        when {
            params {
              input = "$baseDir/tests/data/samples_full.csv"
            }
        }

        then {
            assert workflow.success
        }

    }

}
