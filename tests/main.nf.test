nextflow_pipeline {

    name "spatial-ir-pipeline Tests"
    script "main.nf"

    tag "pipeline"

    config "conf/test.config"

    test("Should produce an error with invalid sample sheet format") {

        tag "invalid_sample_format"
        tag "pipeline_errors"
        tag "errors"

        when {
            params {
              input = 'dummy'
            }
        }

        then {
            assert workflow.failed
            def err = (workflow.errorReport ?: workflow.stderr ?: "NO ERROR MESSAGE").toString()
            assert err.contains("\"dummy\" does not match")
        }

    }

    test("Should produce an error with invalid sample sheet sample path format") {

        tag "invalid_sample_path"
        tag "pipeline_errors"
        tag "errors"

        when {
            params {
              input = "$baseDir/tests/data/samples_bad_path.csv"
            }
        }

        then {
            assert workflow.failed
            def err = (workflow.errorReport ?: workflow.stderr ?: "NO ERROR MESSAGE").toString()
            assert err.contains("the file or directory 'dummy_path1' does not exist")
        }

    }

    test("Should run successfully with base input (no alignment or fastqc)") {

        tag "valid_basic_pipeline"

        when {
            params {
              input = "$baseDir/tests/data/samples.csv"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should run successfully with mixcr alignment and fastqc") {

        tag "valid_mixcr_pipeline"

        when {
            params {
              input = "$baseDir/tests/data/samples_test_mixcr.csv"
            }
        }

        then {
            assert workflow.success
        }

    }

    test("Should run successfully when only some samples need alignment") {

        tag "valid_full_pipeline"

        when {
            params {
              input = "$baseDir/tests/data/samples_full.csv"
            }
        }

        then {
            assert workflow.success
        }

    }

}
