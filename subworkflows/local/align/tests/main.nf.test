nextflow_workflow {

    name "test workflow ALIGN"
    script "../main.nf"
    workflow "ALIGN"

    tag "subworkflows"
    tag "subworkflows_local"

    config "conf/test.config"

    test("test with basic sample input channel"){

        tag "subworkflows_align"
        tag "subworkflows_align_basic"

        when {

            workflow {
                """
                input[0] = Channel.of([
                        [ id:'test' ],
                        file("$baseDir/tests/data/pt16"),
                        [],
                        true,
                        'pt16_downsample_L001_R1_001.fastq.gz,pt16_downsample_L001_R2_001.fastq.gz',
                        file("$baseDir/tests/data/pt16/spatial_ir/ir_fastq")
                    ])
                """
            }
        }

        then {

            def stable_work_files = getAllFilesFromDir(workflow.out.merged.get(0).get(1), false, ['**/*fastq.gz'], null, ['*', '**/*'])

            assertAll(
                { assert workflow.success },
                { assert snapshot(
                        stable_work_files*.name,
                        workflow.out.versions,
                        path(workflow.out.versions[0]).yaml
                    ).match()
                }
            )
        }
    }

    test("test with sample input channel and multiple align sets"){

        tag "subworkflows_align"
        tag "subworkflows_align_multi"

        when {
            params {
                outdir = "$workDir"
            }
            workflow {
                """
                input[0] = Channel.of([
                        [ id:'test' ],
                        file("$baseDir/tests/data/pt16"),
                        [],
                        true,
                        'pt16_downsample_L001_R1_001.fastq.gz,pt16_downsample_L001_R2_001.fastq.gz,pt16_downsample_L001_R1_001.fastq.gz,pt16_downsample_L001_R2_001.fastq.gz',
                        file("$baseDir/tests/data/pt16/spatial_ir/ir_fastq")
                    ])
                """
            }
        }

        then {

            def stable_work_files = getAllFilesFromDir(params.outdir, false, ['pipeline_info/*', '**/*fastq.gz'], null, ['*', '**/*'])

            assertAll(
                { assert workflow.success },
                { assert snapshot(
                        stable_work_files*.name,
                        workflow.out.versions,
                        path(workflow.out.versions[0]).yaml
                    ).match()
                }
            )
        }
    }

    test("test with no alignment requested"){

        tag "subworkflows_align"
        tag "subworkflows_align_no_align"

        when {
            workflow {
                """
                input[0] = Channel.of([
                        [ id:'test' ],
                        file("$baseDir/tests/data/pt16"),
                        '1',
                        false,
                        [],
                        []
                    ])
                """
            }
        }

        then {
            assertAll(
                { assert workflow.success },
                { assert snapshot(
                        workflow.out.merged.get(0).get(1).toString()
                        //workflow.out.versions,
                        //path(workflow.out.versions[0]).yaml
                    ).match()
                }
            )
        }
    }

    test("test with multiple samples and different configurations"){

        tag "subworkflows_align"
        tag "subworkflows_align_full_mix"

        when {
            params {
                outdir = "$workDir"
            }
            workflow {
                """
                input[0] = Channel.of(
                    [
                        [ id:'test' ],
                        file("$baseDir/tests/data/pt16"),
                        [],
                        true,
                        'pt16_downsample_L001_R1_001.fastq.gz,pt16_downsample_L001_R2_001.fastq.gz,pt16_downsample_L001_R1_001.fastq.gz,pt16_downsample_L001_R2_001.fastq.gz',
                        file("$baseDir/tests/data/pt16/spatial_ir/ir_fastq")
                    ],
                    [
                        [ id:'test2' ],
                        file("$baseDir/tests/data/pt16"),
                        [],
                        true,
                        'pt16_downsample_L001_R1_001.fastq.gz,pt16_downsample_L001_R2_001.fastq.gz',
                        file("$baseDir/tests/data/pt16/spatial_ir/ir_fastq")
                    ],
                    [
                        [ id:'test3' ],
                        file("$baseDir/tests/data/pt16"),
                        '1',
                        false,
                        [],
                        []
                    ],
                    [
                        [ id:'test4' ],
                        file("$baseDir/tests/data/pt16"),
                        [],
                        false,
                        [],
                        []
                    ]
                )
                """
            }
        }

        then {

            def stable_work_files = getAllFilesFromDir(params.outdir, false, ['pipeline_info/*', '**/*fastq.gz'], null, ['*', '**/*'])

            assertAll(
                { assert workflow.success },
                { assert snapshot(
                        stable_work_files*.name,
                        workflow.out.merged.get(2).get(1).toString(),
                        workflow.out.merged.get(3).get(1).toString(),
                        workflow.out.versions,
                        path(workflow.out.versions[0]).yaml
                    ).match()
                }
            )
        }
    }
}
